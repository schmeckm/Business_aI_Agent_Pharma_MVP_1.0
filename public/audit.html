<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audit Log Viewer</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Universal Header Styles */
    .header {
      background: linear-gradient(135deg, #0a2540 0%, #2563eb 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

.phase-badge {
  background: #2563eb;
  color: #fff;
  font-size: 10px;
  font-weight: bold;
  padding: 4px 4px;  /* Gleiche Höhe, aber weniger horizontaler Platz */
  border-radius: 10px;
  margin-left: 6px;
  display: inline-block;
  min-width: auto;
}

    .health-indicator {
      position: absolute;
      top: 15px;
      right: 20px;
      display: flex;
      align-items: center;
      font-size: 12px;
      background: white;
      color: #333;
      padding: 5px 10px;
      border-radius: 15px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .health-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
      font-size: 12px;
      text-align: center;
      line-height: 12px;
    }

    .health-green { color: #28a745; }
    .health-yellow { color: #ffc107; }
    .health-red { color: #dc3545; }
    .health-gray { color: #6c757d; }
    
    /* Navigation Styles */
    .nav-menu { 
      background: #f8f9fa; 
      padding: 10px; 
      margin-bottom: 20px; 
      border-radius: 6px; 
      border: 1px solid #ddd; 
    }
    .nav-menu h3 { 
      margin: 0 0 10px 0; 
      color: #333; 
      font-size: 14px; 
    }
    .nav-links { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
    }
    .nav-link { 
      background: #007bff; 
      color: white; 
      padding: 6px 12px; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 12px; 
      transition: background-color 0.2s; 
    }
    .nav-link:hover { 
      background: #0056b3; 
      color: white; 
    }
    .nav-link.oee { background: #28a745; }
    .nav-link.oee:hover { background: #1e7e34; }
    .nav-link.editor { background: #6f42c1; }
    .nav-link.editor:hover { background: #5a32a3; }
    .nav-link.active { background: #1d4ed8 !important; font-weight: 600; }

    /* Audit Log Specific Styles */
    .content-area {
        padding: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      margin-top: 0;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    th, td {
      padding: 12px;
      border: 1px solid #d1d5db;
      text-align: left;
      vertical-align: top;
      color: #1f2937;
    }
    
    th {
      background: #f3f4f6;
      color: #374151;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 13px;
    }
    
    tr:nth-child(even) {
      background: #f9fafb;
    }

    /* Cell Content Styles */
    .timestamp {
      font-size: 11px;
      color: #6b7280;
      font-family: monospace;
    }
    
    .response {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.9em;
      background: #fcfdfe;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Status Colors */
    .status-success {
      color: #059669;
      font-weight: 600;
    }
    .status-error {
      color: #dc2626;
      font-weight: 600;
    }
    .status-info {
      color: #2563eb;
      font-weight: 600;
    }
    .status-warning {
        color: #f59e0b;
        font-weight: 600;
    }
    .status-default {
        color: #6b7280;
    }

    .loading {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #d1d5db;
      border-top: 2px solid #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Universal Header Template -->
    <div class="header">
      <h1>
        Pharmaceutical Manufacturing Agentic Business Agent - MAR Process
        <div class="phase-badge">MVP <span id="app-version">1.3.0</span></div>
      </h1>
      <div id="health-indicator" class="health-indicator">
        <div class="health-dot" id="health-dot">●</div>
        <span id="health-text">Checking...</span>
      </div>
      <div style="font-size: 14px; opacity: 0.9;">Enterprise AI Operations Platform - Real-time OEE Integration</div>
    </div>

    <!-- Navigation Menu -->
    <div class="nav-menu">
      <h3>System Tools & Monitoring</h3>
      <div class="nav-links">
        <a href="/" class="nav-link">Dashboard</a>
        <a href="/oee-test.html" class="nav-link oee">Live OEE Monitor</a>
        <a href="/agent-editor.html" class="nav-link editor">Agent Configuration Editor</a>
        <a href="/audit.html" class="nav-link active">Audit Log Viewer</a>
        <a href="/api/system/health" class="nav-link" target="_blank">System Health</a>
        <a href="/api/data/oee" class="nav-link oee" target="_blank">OEE API</a>
        <a href="/api/agents" class="nav-link" target="_blank">Agent Registry</a>
      </div>
    </div>

    <!-- Page specific content -->
    <div style="margin-bottom: 20px; padding: 0 20px;">
      <h2 style="margin: 0; color: #0a2540;">Audit Log Viewer (Part 11 / ALCOA+)</h2>
      <p style="margin: 5px 0; color: #666;">GMP-compliant audit trail for pharmaceutical manufacturing operations</p>
    </div>

    <div class="content-area">
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>User</th>
            <th>Command/Event</th>
            <th>AI Response / Details</th>
            <th>Status/Type</th>
          </tr>
        </thead>
        <tbody id="log-rows">
          <tr><td colspan="5" style="text-align: center; padding: 20px;"><div class="loading"></div> Loading audit log...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
  // Universal Health Check JavaScript
  async function updateHealthIndicator() {
    const healthDot = document.getElementById('health-dot');
    const healthText = document.getElementById('health-text');

    try {
      let response = await fetch('http://localhost:4000/api/system/health');
      const health = await response.json();

      if (health.status === 'ok' || health.status === 'healthy') {
        healthDot.className = 'health-dot health-green';
        healthText.textContent = 'System OK';
      } else if (health.status === 'error' || health.status === 'unhealthy') {
        healthDot.className = 'health-dot health-red';
        healthText.textContent = 'Error';
      } else {
        healthDot.className = 'health-dot health-yellow';
        healthText.textContent = 'Warning';
      }

    } catch (error) {
      healthDot.className = 'health-dot health-red';
      healthText.textContent = 'API Error';
      console.error('Health check failed:', error);
    }
  }

  // Load version information
  async function loadVersionInfo() {
    try {
      const response = await fetch('http://localhost:4000/api/version');
      const info = await response.json();

      const appVersion = document.getElementById('app-version');
      if (appVersion) appVersion.textContent = info.version;

    } catch (error) {
      console.warn('Could not load version info:', error);
    }
  }

  // Initialize universal functions
  document.addEventListener('DOMContentLoaded', () => {
    updateHealthIndicator();
    loadVersionInfo();
    setInterval(updateHealthIndicator, 30000);
    loadAuditLog();
  });

  // Audit Log specific functionality
  async function loadAuditLog() {
    try {
      const res = await fetch("http://localhost:4000/api/audit");
      const data = await res.json();

      const tbody = document.getElementById("log-rows");
      tbody.innerHTML = "";

      // Normalize nested structures
      let entries = [];
      if (Array.isArray(data)) {
        entries = data;
      } else if (Array.isArray(data.entries)) {
        entries = data.entries;
      } else if (data.entries && Array.isArray(data.entries.entries)) {
        entries = data.entries.entries;
      }

      if (entries.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5' style='text-align: center; color: #6b7280; padding: 30px;'>No audit entries found.</td></tr>";
        return;
      }

      entries.forEach(entry => {
        const tr = document.createElement("tr");

        // Timestamp
        const tdTime = document.createElement("td");
        if (entry.timestamp) {
          const localTime = new Date(entry.timestamp).toLocaleString(undefined, {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false
          });
          tdTime.innerHTML = `<div class="timestamp">${localTime}</div>`;
        } else {
          tdTime.innerHTML = "<div class='timestamp'>-</div>";
        }

        // User
        const tdUser = document.createElement("td");
        tdUser.textContent = entry.user || entry.userName || entry.userId || "-";

        // Command/Event
        const tdCommand = document.createElement("td");
        tdCommand.textContent = entry.message || entry.action || entry.event || "-";

        // AI Response / Details
        const tdAI = document.createElement("td");
        tdAI.className = "response";
        try {
            const responseText = entry.response || (entry.details ? JSON.stringify(entry.details, null, 2) : "-");
            // Truncate long responses for better table layout
            tdAI.textContent = responseText.length > 200 ? responseText.substring(0, 200) + "..." : responseText;
        } catch (e) {
            tdAI.textContent = entry.response || String(entry.details) || "-";
        }

        // Status/Type
        const tdStatus = document.createElement("td");
        const statusText = (entry.status || entry.type || "").toLowerCase();
        tdStatus.textContent = entry.status || entry.type || "-";
        
        if (statusText === "success" || statusText === "ok" || statusText === "verified" || statusText === "complete" || statusText.includes("enabled") || statusText.includes("active")) {
            tdStatus.className = "status-success";
        } else if (statusText === "error" || statusText === "failed" || statusText === "critical" || statusText.includes("fail") || statusText.includes("issue")) {
            tdStatus.className = "status-error";
        } else if (statusText === "warning" || statusText === "pending" || statusText.includes("alert")) {
            tdStatus.className = "status-warning";
        } else if (statusText === "info" || statusText === "processing" || statusText.includes("running")) {
            tdStatus.className = "status-info";
        } else {
            tdStatus.className = "status-default";
        }

        tr.appendChild(tdTime);
        tr.appendChild(tdUser);
        tr.appendChild(tdCommand);
        tr.appendChild(tdAI);
        tr.appendChild(tdStatus);
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error("Failed to load audit log:", err);
      document.getElementById("log-rows").innerHTML =
        `<tr class='status-error'><td colspan='5' style='text-align: center; color: #dc2626; padding: 20px;'>Error loading audit log: ${err.message}</td></tr>`;
    }
  }
</script>
</body>
</html>